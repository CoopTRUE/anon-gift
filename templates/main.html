<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.3/web3.min.js" integrity="sha512-Ws+qbaGHSFw2Zc1e7XRpvW+kySrhmPLFYTyQ95mxAkss0sshj6ObdNP3HDWcwTs8zBJ60KpynKZywk0R8tG1GA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        'use strict';
        const serverWallet = '0x938B94f5E7E9D7e08ED064C3ba9349725FC1B152';
        let mainWallet;

        const provider = window.ethereum
        const web3 = new Web3(provider)


        function toggle() {
            if (typeof provider === 'undefined') {
                alert('Please install web3 wallet!');
                return;
            }
            provider.request({ method: 'eth_requestAccounts' }).then(() => {;
                checkConnection();
            })
        }

        function sendTransaction() {
            const selectedCurrency = document.getElementById('usdType').value;
            const abi = [{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"constant":true,"inputs":[],"name":"_decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"_name","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"_symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"renounceOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}];
            let coinAddress;
            if (selectedCurrency == 'busd') {
                coinAddress = '0xe9e7cea3dedca5984780bafc599bd69add087d56'
            } else if (selectedCurrency == 'usdc') {
                coinAddress = '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d'
            } else {
                coinAddress = '0x55d398326f99059ff775485246999027b3197955'
            }

            const contract = new web3.eth.Contract(abi, coinAddress)
            console.log(contract.methods)
            contract.methods.transfer(mainWallet, web3.utils.toWei(document.getElementById('usdValue').value, 'ether')).send({
                'from': mainWallet,
                'value': 0,
                'gas': 250000,
                'gasPrice': web3.utils.toWei('5', 'gwei'),
            }).then(txnHash => {
                document.getElementById("txnText").value = txnHash.slice(23);
                document.getElementById("getCardButton").click();
            });

        }

        function checkConnection() {
            if (ethereum.isConnected()) {
                mainWallet = provider.request({ method: 'eth_requestAccounts' }).then(accounts => {mainWallet=accounts[0]});
                document.getElementById('metamaskButton').innerText = 'CONNECTED';
            } else {
                document.getElementById('metamaskButton').innerText = 'CONNECT TO METAMASK';
            }
        }

        function getCard() {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://127.0.0.1:5000/transaction/' + document.getElementById("cardType").value);
            xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded;charset=UTF-8');;
            xhr.send('txn-hash='+document.getElementById("txnText").value);
            xhr.onreadystatechange = function() {
              if (xhr.readyState == 4 && xhr.status == 200) {
                  alert(xhr.responseText);
              }
            };
        }

        setTimeout(() => { checkConnection() }, 200);

        ethereum.on('chainChanged', (chainId) => {
          window.location.reload();
        });

        ethereum.on('disconnect', () => {
            console.log("test")
            checkConnection();
        });
    </script>
    <title>Testing</title>
</head>
<body>
    <button onclick="toggle()" id="metamaskButton">CONNECT TO METAMASK</button>

    <div>CARD TYPE | VALUE | CRYPTO TYPE</div>
    <select name="cardType" id="cardType">
        <option value="visa">Visa Credit Card</option>
        <option value="amazon">Amazon Gift Card</option>
    </select>
    <select name="usdValue" id="usdValue">
        <option value="5">$5</option>
        <option value="10">$10</option>
        <option value="20">$20</option>
        <option value="50">$50</option>
    </select>
    <select name="usdType" id="usdType">
        <option value="busd">BUSD</option>
        <option value="usdc">USDC</option>
        <option value="usdt">USDT</option>
    </select><br><br>

    <button onclick="sendTransaction()">SEND TRANSACTION</button>
    <div id="sendText"></div><br><br>
    <input type="url" id="txnText">
    <button onclick="getCard()" id="getCardButton">Get Card!</button>
</body>
</html>